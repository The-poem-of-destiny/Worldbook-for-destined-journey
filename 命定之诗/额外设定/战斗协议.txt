<战斗协议>
战斗:
  核心指令: 在任何战斗场景，必须严格遵循本协议，战斗前显示所有新角色char_info

# 第一阶段: 战况总览
  逻辑与规则:
    1. 战斗类型: 切磋/竞技/压制/死斗/标准/敌方守卫战
    2. 回合资源: 每单位拥有1[攻击]1[动作]
    3. 敌人生成: 若存在≥3个同类低级敌人，聚合为[集群]单位(资源=个体×N)
    4. 状态展示: 必须列出所有友方敌方参战单位的完整资源、核心属性及当前状态
    5. 频率: 每回合开始输出一次

  面板模板:
    {战况总览}
    | 回合: [当前回合数] | 类型: [战斗类型] | 环境: [简述环境/距离] |
    | <user>: HP [X/X] | MP [X/X] | SP [X/X] | 力[X] 敏[X] 体[X] 智[X] 精[X] |
    | 状态: [状态A(N回合), 状态B] |
    | [敌人名/集群名 (xN)]: HP [X/X] | MP [X/X] | SP [X/X] | 力[X] 敏[X] 体[X] 智[X] 精[X] |
    | 状态: [状态A(N回合), 状态B] |

  叙事指导: (描写当前的对峙局势、环境氛围、角色的状态外貌，为本回合定调)

# 第二阶段: 行动顺序
  逻辑与规则:
    1. 公式: '(敏捷 × (1 + %修正)) + d20池数值 + 固定修正'
    2. 排序: 面板列表顺序<user>→队友A...→敌人A...，行动序列总值从高到低，生成本回合行动轴
    3. 频率: 每回合输出一次

  面板模板:
    {行动顺序}
    | [角色A]: (敏捷[X] × (1+[来源]修正[Z%])) + 骰[Y] + [来源]固定修正[W] = [总值] |
    | [角色B]: (敏捷[X] × (1+[来源]修正[Z%])) + 骰[Y] + [来源]固定修正[W] = [总值] |
    | 序列: [角色A] -> [角色B] -> ... |

  叙事指导: (描写双方的反应速度，谁先动了，谁慢了一拍，空气中紧绷的一触即发感)

# 第三阶段: 攻击行动 (核心循环)
  逻辑与规则:
    1. 消耗1[攻击]
    2. 攻击次数: 非集群单位攻击次数严格由技能[标签]决定。仅当技能拥有[多段]或[连击]标签时，N才大于1，否则N恒定为1；集群攻击次数N，低于HP百分比/N次数(80%,3;50%,2;30,1)
    3. 意图与压制解析 (核心逻辑):
        - 条件约束: 仅在<user> 输入中包含特定肉体部位(眼/喉)或超凡概念(魔力回路/权能节点/法则具象/灵魂)或明确的抹杀描述(斩首/湮灭/吞噬)，视为[战术/瞄准]。否则默认为[常规]
        - 查表: 战术部位与致死意图表
        - 层级压制: 若 攻方层级 < 守方层级 - 1，强制无效，保留命中修正，意图系数重置为1.0，无法施加额外状态(表现为未破防/伤害无效等)
        - 生死判定: 无论意图多么致死(如切断头颅/粉碎心脏)，若最终结算 HP > 0，强制判定为[未死/存活]。叙事上解释为被闪避/偏折/硬抗/肉体虽毁但能量重组/本身非要害等，而非直接判定死亡
    4. 攻击检定:
        - d20池: 攻方层级>守方(取2d20高位，优势)；攻方<守方(取2d20低位，劣势)；相等(1d20)
        - 闪避无效: 仅当 攻击方层级 > 目标层级 + 1 时，目标闪避修正无效
        - 评级: 20(暴击,系数1.2) | 11-19(有效,系数1.0) | 8-10(勉强,系数0.8) | 4-7(擦伤,系数0.3) | 1-3(失手,系数0)
    5. 伤害计算:
        - 初始伤害: '关联属性×10 × 层级系数 + 技能威力 + 武器攻击力'。若为多段/连击，此值为总和，需除以段数N
        - 装备减免: '伤害构成值 × (对应部位防御 / (对应部位防御 + 2000))'
        - 各类型伤害属性减免:
          物理: '(最终体质+最终力量+最终敏捷)×0.25%'
          能量: '(最终精神+最终智力)×0.4%'
          精神: '最终精神×0.8%'
          真实: 0 (真实伤害无视所有装备与属性减免)
        - 结算伤害: '(伤害构成值 - 装备减免) × (1 - 属性减免%)'
        - 集群修正: 对集群单位的最终伤害 ×1.5 (且无法触发意图/部位攻击)
    6. 范围技能处理:
        - 对多个独立目标: 若技能标签为`范围:x`，索敌x个单位
        - 对集群单位: 对集群总伤害 = `修正后的单体伤害 × min(技能标签范围x, 集群当前数量n)`
    7. 状态(不限数量):
        - 附加效果触发/仅层级压制通过的战术or意图施加:
          暴击: 必触发
          有效/勉强: (攻方属性+d20) vs (守方属性+d20) 对抗检定
          擦伤/失手: 不触发

  面板模板:
    {攻击行动}
    | 攻方: [攻击者] | 守方: [目标] | 招式: [技能名] | 所使武器: [装备名] |
    | 消耗: HP [X] | MP [X] | SP [X] |
    | 意图: [描述关键词] -> 判定为 [常规/机能/核心/抹杀/概念] |
    {伤害基准计算}
    | 初始伤害: ([关联属性]×10×[层级系数] + [技能威力] + [武器攻击]) = [总伤害值] |
    <!-- 仅为伤害型道具时，不计算公式  -->
    | 初始伤害: [道具固定伤害及其它修正] = [总伤害值] |
    <!-- 仅技能为多段/连击  -->
    | [多段/连击(N)]: [总伤害值] / [N] = [单发初始伤害] |
    <!-- 仅攻击者为集群  -->
    | 集群攻击次数: HP百分比[m]-> 次数[N] |
    <!-- 以下为伤害类型计算的通用模板行 -->
    | [伤害类型]伤害(占比%): 构成[A] - 装备减免([装备名] B) - 属性减免(C) = [结算基值 D] |
    <!-- 以上多伤害类型多行。真实伤害的减免为0 -->
    | 基础伤害 (单次基准): ([各结算基值之和]) = [基础伤害值 J] |
    {结算清单}
    <!-- 通用vs单个单位 (含集群)  -->
    | 掷骰: [优势/劣势/正常] d20[骰值] |
    | 命中加值: 常规[来源: 仅技能/装备A]a + 意图Y= [b] |
    | 闪避减值: 闪避值[来源: 仅目标装备/技能]c |
    | 检定结果: [最终骰值] + 命中[b] - 闪避[c] = [总值] | 结果: [评级] |
    | 伤害修正: (基础[J] × 评级系数[K] × 意图系数[L]) + 额外固定伤害([来源] M)  × 攻击次数N= [修正后伤害 N] |
    <!-- 仅目标为集群  -->
    | 集群修正: [修正后伤害 N] × 1.5 = [对集群伤害 P] |
    <!-- 仅范围技能vs集群  -->
    | 范围结算: [P] × min(范围[x], 集群数[n]) = [最终总伤害 Q] |
    | 最终伤害: [N 或 P 或 Q] | 变更: [目标] HP [旧值] -> [新值][当前HP百分比] (-[最终伤害]) |
    | 是否存活: [新值] > 0 -> [未死/存活] | [新值] ≤ 0 -> [死亡/毁坏] |
    | 状态施加([效果名]): [暴击/对抗检定(攻方X vs 守方Y)] -> [触发成功/失败] |
    | 状态效果: [目标]获得[状态名]([具体效果]), 持续[N]回合 |
    <!-- 仅范围技能vs多个独立单位 -->
    | -> [目标A]: 检定([骰->评级]) | 伤害: ([J]×[系数]=[最终值]) | HP: [旧->新] | 效果: [触发/无] |
    | -> [目标B]: 检定([骰->评级]) | 伤害: ([J]×[系数]=[最终值]) | HP: [旧->新] | 效果: [触发/无] |
  
  叙事指导: (具象化描写攻击的视觉效果、动作细节、打击感、受击者的反应及伤口)

# 第四阶段: 战术动作(核心循环)
  逻辑与规则:
    1. 消耗1[动作]
    2. 类型: 使用道具/[动作]技能/装备能力/移动/格挡/专注/其它
    3. 伤害道具: 若使用造成伤害的道具，必须转用{攻击行动}模板，初始伤害来源为固定道具伤害
    4. 逃跑: 逃跑是特殊的战术动作，需进行对抗检定，成功则战斗结束

  面板模板 (非伤害性):
    {战术动作}
    | 角色: [行动者] | 类型: [动作类型，如使用道具、格挡] | 对象: [目标] |
    | 消耗: HP [X] | MP [X] | SP [X] |
    | 执行: 使用 [道具/技能名] |
    | 效果: [恢复HP/MP/SP(+X)] / [获得状态(状态名,状态详细效果描述,N回合)] / [进入格挡姿态,物理减伤X%] / [位移至XX区域] |

  面板模板 (逃跑):
    {战术动作 - 逃跑}
    | 角色: [<user>] | 类型: [逃跑] |
    | 对抗: [场上最高敏捷敌人] |
    | 检定: (<user>敏捷[X]+d20[Y]) vs ([敌人]敏捷[A]+d20[B]) = [数值] vs [数值] |
    | 结果: [逃跑成功/失败] |

  叙事指导: (描写战术动作的具体表现，如喝药的动作、魔法咏唱、走位或防御姿态)

# 第五阶段: 战意判定 (条件触发)
  逻辑与规则:
    1. 触发: 仅非<user>单位HP低于其战斗类型的战意阈值时触发
    2. 阈值与判定:
        - 无需检定(自动[战意动摇]): 切磋(40%)/竞技(30%)/压制(50%)
        - 需要检定(d20<12触发[丧失战意/崩溃]): 死斗(10%)/标准(30%)/守卫(35%)
    3. 结果池: 投降, 认输, 求饶, 溃逃, 撤退, 被击昏, 被俘虏, 中止战斗, 阵线溃散, 内讧等 (不包括死亡)

  面板模板:
    {战意判定}
    | 触发: [角色名] HP [当前/最大] < 阈值 [XX%] |
    | 类型: [战斗类型] -> [无需检定 / 需要检定] |
    | 判定: [自动触发 / d20=[X] vs 12] -> [战意动摇 / 崩溃 / 坚守] |
    | 结果: [角色名] [从结果池选择的行为] |

  叙事指导: (仅当触发时描写。描述敌人的心理防线崩溃、求饶、逃窜具体情节)

# 第六阶段: 战斗结算 (战斗结束时)
  逻辑与规则:
    1. 触发: 只有一方全灭或成功逃跑/投降时输出
    2. 经验值(EXP): 基于被击败目标的等级和层级。集群单位的EXP有特殊计算规则且单次获取有上限
    3. 命运点(FP): 根据战斗难度和表现获得

  面板模板 (胜利):
    {战斗胜利}
    | 结果: [胜利 / 逃跑成功] |
    | 战果: [简述战况后果] |
    <!-- 经验值获取<经验值获取规则>  -->
    | 奖励: EXP +[数值] | FP +[数值] |
    | 掉落: [物品A, 物品B, ...] |

  面板模板 (失败):
    {战斗失败}
    | 结果: [失败] |
    | 后果: [简述失败的境遇] |

  叙事指导: (描写战斗结束后的收尾场景，如收起武器、喘息、查看战利品或描述失败后的惨状)
</战斗协议>