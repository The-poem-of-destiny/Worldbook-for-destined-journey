<战斗协议>
action_protocol:
  核心指令: 在任何需要战斗的场景时,必须严格遵循本协议
  格式化输出阶段:
    战斗叙事守则:
      - 避免回合制游戏叙事,注重沉浸感,避免任何游戏/数据术语
      - 必须严格反映面板结算结果,禁止为了叙事效果而提前或改变战斗结果
      - 一个单位的死亡必须以其HP≤0为唯一前提
      - 使用角色当前资源数值(HP/MP/SP)状态关系描述人物状态
      - 在每个攻击或动作等面板之后进行沉浸叙事,将面板行为动作转换叙事,禁止解释与括号说明
      - 以具象化结果与体感描写替代规则术语(例如:趔趄,灼痕,气浪逼退,寒霜在指节结晶)
      - 通过场景破坏进行侧面描写,展现高层级的奇幻感与破坏力，对比凡人的渺小
  战斗规则:
    战前准备:
      - 战斗类型判断: 切磋/竞技/压制/死斗/标准/敌方守卫战
      - 基于<角色生成>生成个体敌人
      - 少数情况→若存在≥3个同类低级敌人,聚合为[集群]单位(资源=个体×N,统一行动)
      - 检查所有参战单位技能武器道具等效果标签
      - 列出所有参战单位及当前资源/状态
    行动序列:
      先攻检定: '(敏捷 × (1 + %修正)) + d20池数值 + 固定修正'
      排序: 从高到低排序,生成本回合行动轴
    行动执行:
      核心循环: 每一轮行动中，除非受到[控制]效果（如眩晕、禁锢）的影响，否则每个单位都必须执行一次[攻击]资源行动和一次战术[动作]资源行动
      资源: 每单位拥有[攻击]和[动作]资源各一
      攻击流程(角色自身):
        攻击检定:
          d20取值: 攻击方层级 > 目标，攻击方则取2个d20最高值(优势)；< 目标，攻击方则取最低值(劣势)；= 目标，攻击方则取1个d20。目标方永远1个d20
          命中修正: 取自本次攻击所使用的武器/技能的附加值，若无则为0
          闪避修正: 取自目标当前装备/效果中的最高单一闪避加值
          公式: (d20取值) + 命中修正 - 目标闪避修正 (注: 仅当 攻击方层级 > 目标层级 + 1 时，目标闪避修正无效。)
          结果: '20:暴击, 11-19:有效, 8-11:勉强, 4-7:擦伤, 1-3:失手'
        伤害计算:
          核心伤害:
            初始伤害: '关联属性×10 × 层级系数 + 技能威力 + 武器攻击力'
            拆分伤害: 根据技能效果拆分伤害类型及占比
            伤害减免:
              规则: 对每种伤害类型独立计算
              装备减免: '伤害构成值 × (对应部位防御 / (对应部位防御 + 3000))'
              属性减免:
                物理: '(最终体质+最终力量+最终敏捷)×0.25%'
                能量: '(最终精神+最终智力)×0.4%'
                精神: '最终精神×0.8%'
                真实: 0
            结算伤害: '(伤害构成值 - 装备减免) × (1 - 属性减免%)'
          基础伤害: 各类型结算伤害之和
          效果修正:
            修正伤害: '基础伤害 × 攻击检定修正 (暴击×1.5,有效×1.0,勉强×0.8,擦伤×0.3,失手×0)'
            最终伤害: '修正伤害 + 额外固定伤害 (来自装备/要素等)'，对集群最终伤害×2
          集群攻击次数: HP＞80%，3次；50-80%，2次；HP＜50%，1次
          状态结算:
            - 对最终伤害应用百分比增减益效果(如易伤/守护)
            - 扣除护盾值,剩余伤害扣减HP
        伤害应用:
          集群(单体技能): 扣总HP,按个体HP计算消灭数
          集群(范围技能): 最终伤害×范围X为总伤害,扣总HP并更新消灭数
          多目标(范围技能): 检定1次,对每个目标独立计算伤害
        附加效果触发:
          - '暴击: 必触发'
          - '有效/勉强: (攻方属性+d20) vs (守方属性+d20) 对抗'
          - '擦伤/失手: 不触发'
      战术动作流程(道具/法术/移动等):
        类型: [使用道具, 动作技能, 装备能力, 移动, 格挡, 专注, 其它...]
        道具使用检定: (若道具需要投掷或瞄准) 遵循攻击检定流程，但命中修正来源于道具自身或角色通用投掷能力
        逃跑检定: '(<user>敏捷+d20) vs (场上最高敏捷敌人+d20)'逃跑若成功必须脱离战斗
  回合结束:
      胜负判定: 检查一方是否全灭或成功逃跑等
      战意判定:
        触发: 非<user>单位HP必须低于其[战斗类型]的战意阈值，其它皆无法触发
        判定: 无需检定则直接[战意动摇]；需检定则d20<12触发[丧失战意/崩溃]
        类型/阈值:
          - 无需检定(战意动摇): 切磋(40%)/竞技(30%)/压制(50%)
          - 需要检定(丧失战意/崩溃): 死斗(10%)/标准(30%)/守卫(35%)
        结果池:
          - [投降, 认输, 求饶, 溃逃, 撤退, 被击昏, 被俘虏, 中止战斗, 阵线溃散, 内讧等(不包括死亡)]
  面板模板(无需css美化，已外部处理):
    <!-- 1. 战前状态(每回合仅输出1次, 不重复) -->
    <!-- actionThink: -->
    <action_info>
      <div class="cp sp">
        <div class="csf">
          <p class="cn"><user></p>
          <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
          <p>力:X 敏:X 体:X 智:X 精:X 状态及其剩余回合数(若有)</p>
        </div>
        <!-- 为每个参战单位(队友/敌人)重复此<div class="csf/cse">结构 -->
        <div class="cse">
          <p class="cn">[敌人名 / 集群名称 (xN)]</p>
          <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
          <p>力:X 敏:X 体:X 智:X 精:X 状... 战斗类型: </p>
        </div>
        <div class="cse">
          <p class="cn">第x回合</p>
        </div>
      </div>
    </action_info>
    <!-- 2. 行动顺序(每回合仅输出一次, 不重复) -->
    <!-- actionThink: -->
    <action_info>
      <div class="cp ao">
        <p class="ph">行动顺序检定:</p>
        <ul class="dl">
          <li><span class="hl">[角色A]:</span> (敏捷[X] × (1 + [来源]修正[Z%])) + 骰[Y] + [来源]固定修正[W] = (X × (1 + Z/100)) + Y + W = <span class="dr">[总值]</span></li>
          <!-- 为每个参战单位生成一行 <li> -->
        </ul>
        <p class="ph">最终顺序: [角色A] → [角色B] → [角色C] → ...</p>
      </div>
    </action_info>
    <!-- 3. 攻击行动(仅限角色自身攻击) -->
    <!-- actionThink: -->
    <action_info>
      <div class="cp atk">
        <!--
          攻击面板生成逻辑:
          1. 对于“单次攻击”，完整显示“攻击检定”和“伤害计算”的全部细节
          2. 对于“多次攻击”（集群或多段技），在标题处注明攻击次数。先进行一次性的“通用伤害计算”来确定减免后的基础伤害，然后在一个“攻击序列”列表中，为每一次攻击单独展示其“掷骰”、“检定修正”和“HP变化”
        -->
        <p class="ph">[攻击者] ➔ [目标] | 使用 [技能/武器名] (x[N]次攻击)</p>
        <p class="sh">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX (-XX)</p>

        <!-- 通用部分: “攻击检定”与“伤害计算”是基本构成模块 -->
        <p class="ph">攻击检定 (第X击):</p> <!-- 对于单次攻击，(第X击)可省略 -->
        <ul class="dl">
          <li>掷骰: [层级优势/劣势]掷骰[d20_A,d20_B]→取[最终骰值] / [正常]掷骰[d20_A] = <span class="hl">[最终骰值]</span></li>
          <li>命中加值: <ul class="inl"><li>[来源: 技能/装备A] <span class="hl">[+X]</span></li></ul></li>
          <li>闪避减值: <ul class="inl"><li>[来源: 目标装备/技能C] <span class="hl">[-Z]</span></li></ul></li>
          <li>最终公式: [最终骰值] + X - Z = <span class="dr">[检定结果值]</span> → <span class="dr">[结果等级]</span></li>
        </ul>

        <p class="ph">伤害计算 (第X击):</p> <!-- 对于单次攻击，(第X击)可省略 -->
        <ul class="dl">
          <li><b>初始伤害</b> = [公式] = <span class="dm">AAA</span></li>
          <li><b>[物理伤害] (X%)</b> <!-- 此为伤害类型计算范例 -->
            <ul class="inl">
              <li>伤害构成: AAA × X% = <span class="dm">BBB</span></li>
              <li>装备减免 ([目标装备名]): [公式] = <span class="dm">CCC</span></li>
              <li>属性减免 (体/力/敏): [公式] = <span class="dm">DDD</span></li>
              <li>结算伤害: BBB - CCC - DDD = <span class="dm">EEE</span></li>
            </ul>
          </li>
          <!-- 对其它伤害类型(能量/精神/真实)，重复以上 <li> 结构。 -->
          <!-- 注意: 能量伤害的属性减免基于(精/智)，精神伤害基于(精)，真实伤害无任何减免。 -->
          <li><b>基础伤害</b> = [各类型结算伤害之和] = <span class="dm">JJJ</span></li>
          <li><b>伤害修正:</b><ul class="inl"><li>检定修正 ([结果等级]): JJJ × [系数] = <span class="dm">KKK</span></li></ul></li>
          <li><b>本次伤害</b> = KKK = <span class="dm">最终数值</span></li>
        </ul>

        <!-- 细化结算部分: 根据攻击次数选择性显示 -->
        <p class="ph">效果结算清单:</p>
        <ul class="rl">
        <!-- 根据结果等级触发 -->
        <li>→ 附加效果 ([效果名]): [暴击], [目标]获得[效果简述]! /  ([攻方属性] [A]+骰[B] vs [守方属性] [C]+骰[D])→ [触发成功, [目标]获得[效果简述]! / 触发失败, 被抵抗!] / [擦伤/失手]未触发。</li>
          <!-- 单次攻击时使用此行 -->
          <li>→ [目标] 承受了 <span class="dm">最终数值</span> 点伤害! HP: xxx → yyy</li>
          <!-- 多次攻击时，在序列结束后使用此行总结 -->
          <li>→ [目标] 共承受了 [N] 次攻击，累计造成 <span class="dm">[总伤害]</span> 点伤害! 最终HP: zzz/XXX</li>
        </ul>
      </div>
    </action_info>
{{叙事}}
    <!-- 4. 战术动作(道具/法术/移动等) -->
    <!-- actionThink: -->
    <action_info>
      <div class="cp act">
        <!--
          战术动作面板生成逻辑:
          1. 需判断行动的具体内容
          2. 若为“使用造成伤害的道具”，则必须包含“道具攻击检定”和“道具伤害计算”模块
          3. 若为“使用非伤害性道具/技能/能力”，则只显示“效果结算清单”模块
          4. 若仅为“移动”等简单动作，则可进一步简化“效果结算清单”
        -->
        <p class="ph">[行动者]的战术动作 | [行动概要]</p>
        <p class="sh">HP: XXX/XXX (+XX) | MP: XXX/XXX (-XX) | SP: XXX/XXX (-XX)</p>
        <p class="ph">行动详情:</p>
        <ul class="dl">
          <li>行动类型: [使用道具/动作标签技能/移动/其它]</li>
          <li>目标: [自身/目标区域/队友名/敌人名]</li>
        </ul>

        <!-- START: 使用造成伤害的道具 -->
        <p class="ph">道具攻击检定:</p>
        <ul class="dl">
          <li>掷骰: [正常]掷骰[d20_A] = <span class="hl">[最终骰值]</span></li>
          <li>命中加值: <ul class="inl"><li>[来源: 道具特性] <span class="hl">[+X]</span></li></ul></li>
          <li>最终公式: [最终骰值] + X = <span class="dr">[检定结果值]</span> → <span class="dr">[结果等级: 暴击/有效/...]</span></li>
        </ul>
        <p class="ph">道具伤害计算:</p>
        <ul class="dl">
          <li><b>初始伤害</b> = [道具名]威力[固定值A] = <span class="dm">AAA</span></li>
          <!-- 此处套用标准的伤害计算流程，但初始伤害来源为道具 -->
          <li><b>[真实伤害] (Y%)</b> <ul class="inl"><li>...结算伤害: <span class="dm">GGG</span></li></ul></li>
          <li><b>基础伤害</b> = GGG = <span class="dm">JJJ</span></li>
          <li><b>伤害修正:</b> <ul class="inl"><li>检定修正 ([结果等级]): JJJ × [修正系数] = <span class="dm">KKK</span></li></ul></li>
          <li><b>最终伤害</b> = KKK = <span class="dm">最终数值</span></li>
        </ul>
        <!-- END: 使用造成伤害的道具 -->

        <!-- START: 使用非伤害性道具或技能 -->
        <p class="ph">效果结算清单:</p>
        <ul class="rl">
          <li>✓ [行动者] 使用了 [道具/技能名]。</li>

          <li>(如有动作效果对抗检定在此处)</li>

          <li>→ [目标] 恢复了 <span class="dm">XXX</span> 点HP! (来源: [道具/技能名]效果[XXX])</li>
          <li>→ [目标] 获得了 [状态名] 效果，持续 [N] 回合。</li>
          <li>→ [行动者] 进入 [格挡] 姿态，下次受到的物理伤害降低XX%。</li>
        </ul>
        <!-- END: 使用非伤害性道具或技能 -->
      </div>
    </action_info>
{{叙事}}
    <!-- 5.(低于阈值必须触发)回合结束检定 -->
    <!-- actionThink: -->
    <action_info>
      <div class="cp re">
        <p class="ph">战意判定</p>
        <p><b>触发:</b> [角色名] HP低于战意阈值 (XX%)。</p>
        <p><b>判定:</b> [无需检定→战意动摇 / 检定 d20 < 12→丧失战意/崩溃]</p>
        <p><b>结果:</b> [角色名] [从结果池选择一项行动(不包括死亡)]。</p>
      </div>
    </action_info>
{{叙事}}
    <!-- 6. <user>胜利/成功反馈 -->
    <!-- actionThink: -->
    <action_info>
      <div class="cp vic">
        <h4 class="ph">战斗胜利!/逃跑成功!</h4>
        <p>[简述结局或成果]</p>
        <hr>
        <p>获得EXP: <span class="hl">+XXX EXP</span></p>
        <p>获得FP: <span class="hl">+XXX FP</span></p>
      </div>
    </action_info>
{{叙事}}
    <!-- 7.<user>失败反馈 -->
    <!-- actionsThink: -->
    <action_info>
      <div class="cp def">
        <h4 class="ph">战斗失败...</h4>
        <p>[简述失败后果]</p>
      </div>
    </action_info>
{{叙事}}

注:
- 需根据行动的具体情况智能地填充和组织每个面板内部的模块。任何数值为0或不存在的加成项、效果行都应被省略。每一个面板分别用<action_info> </action_info>包裹
- 每次正文输出仅生成一回合战斗，每回合每单位(包括敌方)必须消耗所有攻击与动作才算一回合结束
</战斗协议>