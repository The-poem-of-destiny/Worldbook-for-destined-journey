<status_current_variables>
<%_ {
  // 获取完整数据并移除事件（事件数据仅用于内部处理，不输出）
  const data = getMessageVar('stat_data', { defaults: {} });
  const cleanData = _.omit(_.cloneDeep(data), '事件');

  // 登神长阶等级阈值配置
  const ascensionThresholds = [
    { level: 13, fields: ['要素'] },
    { level: 17, fields: ['权能'] },
    { level: 21, fields: ['法则'] },
    { level: 25, fields: ['神位', '神国'] }
  ];

  // 处理"登神长阶"的显示逻辑
  const getVisibleAscensionFields = (data, level) => {
    if (!data) return data;
    if (data.是否开启 !== true) return _.pick(data, '是否开启');

    const visibleKeys = _.chain(ascensionThresholds)
      .filter(t => level >= t.level)
      .flatMap('fields')
      .value();

    return _.pick(data, ['是否开启', ...visibleKeys]);
  };

  // 命定之人离场时的可见字段（基于 schema.json 定义）
  const absentPersonFields = ['是否在场', '生命层级', '等级', '种族', '身份', '职业', '性格', '外貌', '好感度', '心里话'];

  // 处理主角的登神长阶
  if (_.get(cleanData, '主角.登神长阶')) {
    cleanData.主角.登神长阶 = getVisibleAscensionFields(
      cleanData.主角.登神长阶,
      _.get(cleanData, '主角.等级', 1)
    );
  }

  // 处理命定之人
  _.forOwn(_.get(cleanData, '命定系统.命定之人'), (personData, personKey) => {
    if (!personData.是否在场 && !personData.是否缔结契约) {
      // 不在场且未缔结契约：只展示基础信息
      cleanData.命定系统.命定之人[personKey] = _.pick(personData, absentPersonFields);
    } else if (personData.登神长阶) {
      // 在场或已缔结契约：处理登神长阶可见性
      personData.登神长阶 = getVisibleAscensionFields(personData.登神长阶, personData.等级 || 1);
    }
  });
_%>
<%= YAML.stringify(cleanData, { blockQuote: 'literal' }) _%>
<%_ } _%>
</status_current_variables>