<行动协议>
action_protocol:
  核心指令: 触发任何需要检定的场景时,必须严格遵循本协议
  思考阶段:
    预生成骰子池:
      规则: 本次正文所有随机数,必须从此处的检定池中严格按顺序索引取用
      d20池_60: [{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}}
  格式化输出阶段:
    叙事守则:
      - 基于<fiction_style>
      - 避免回合制游戏叙事,注重沉浸感,避免任何游戏/数据术语
      - 必须严格反映面板结算结果,禁止为了叙事效果而提前或改变战斗结果
      - 一个单位的死亡必须以其HP≤0为唯一前提
      - 使用<数值状态关系>描述人物状态
      - 在多个/单个面板之后进行沉浸叙事,将面板行为动作转换叙事,禁止解释与括号说明
      - 根据攻击节奏与协同攻击，同方攻击行动等面板之间不插入叙事，可多个同方面板结束后统一叙事，同方攻击的叙事部分可不分先后顺序，同时进行
      - 以具象化结果与体感描写替代规则术语(例如:趔趄,灼痕,气浪逼退,寒霜在指节结晶)
      - 通过场景破坏进行侧面描写,展现高层级的奇幻感与破坏力，对比凡人的渺小
  战斗规则:
    战前准备:
      - 战斗类型判断: 切磋/竞技/压制/死斗/标准/敌方守卫战
      - 基于<角色生成>生成个体敌人
      - 少数情况→若存在≥3个同类低级敌人,聚合为[集群]单位(资源=个体×N,统一行动)
      - 列出所有参战单位及当前资源/状态
    行动序列:
      先攻检定: '(敏捷 × (1 + %修正)) + d20池数值 + 固定修正'
      排序: 从高到低排序,生成本回合行动轴
    行动执行:
      资源: 每单位拥有[攻击]和[动作]资源各一
      攻击流程:
        攻击检定:
          掷骰: 取池d20
          结果: '20:暴击, 11-19:有效, 8-11:勉强, 4-7:擦伤, 1-3:失手'
        伤害计算:
          核心伤害:
            初始伤害: '关联属性×10 × 层级系数 + 技能威力 + 武器攻击力'
            拆分伤害: 根据技能效果拆分伤害类型及占比
            伤害减免:
              规则: 对每种伤害类型独立计算
              装备减免: '伤害构成值 × (对应部位防御 / (对应部位防御 + 3000))'
              属性减免:
                物理: '(最终体质+最终力量+最终敏捷)×0.25%'
                能量: '(最终精神+最终智力)×0.4%'
                精神: '最终精神×0.8%'
                真实: 0
            结算伤害: '(伤害构成值 - 装备减免) × (1 - 属性减免%)'
          基础伤害: 各类型结算伤害之和
          效果修正:
            修正伤害: '基础伤害 × 攻击检定修正 (暴击×1.5,有效×1.0,勉强×0.8,擦伤×0.3,失手×0)'
            最终伤害: '修正伤害 + 额外固定伤害 (来自装备/要素等)'，若为集群，最终伤害需×2
          状态结算:
            - 对最终伤害应用百分比增减益效果(如易伤/守护)
            - 扣除护盾值,剩余伤害扣减HP
        伤害应用:
          集群(单体技能): 扣总HP,按个体HP计算消灭数
          集群(范围技能): 最终伤害×范围X为总伤害,扣总HP并更新消灭数
          多目标(范围技能): 检定1次,对每个目标独立计算伤害
        附加效果触发:
          - '暴击: 必触发'
          - '有效/勉强: (攻方核心属性+d20) vs (守方核心属性+d20) 对抗'
          - '擦伤/失手: 不触发'
      动作流程:
        类型: [使用道具,辅助法术,装备能力,逃跑]
        逃跑检定: '(<user>敏捷+d20) vs (场上最高敏捷敌人+d20)'逃跑若成功必须脱离战斗
回合结束:
      胜负判定: 检查一方是否全灭或成功逃跑。
      终结判定:
        触发: 非<user>单位HP低于类型阈值。
        判定: 无需检定类直接触发[终结]；需要检定类d20<12触发[终结]。
        类型/阈值:
          - 无需检定: 切磋(40%)/竞技(30%)/压制(50%)
          - 需要检定: 死斗(10%)/标准(30%)/守卫(35%)
        结果池:
          - 终结: [投降, 认输, 求饶, 逃跑, 撤退, 被击昏/俘虏, 中止, 溃散, 内讧 等等]
  生产制作规则:
    制作准备:
      - 确认制作目标,包括物品名称,品质与数量
      - 检查并消耗所需材料,材料不足则无法开始
      - 识别并应用所有相关的辅助效果,包括来自技能,道具,环境或临时增益的加成
    制作检定(先确定DC值):
      DC: '普通:8, 优良:12, 稀有:16, 史诗:22, 传说:30, 神话:40'，再附加道具/材料的DC加值
      检定公式: '(核心属性 + 技能加成 + 道具加成) + d20'
      核心属性: '锻造:力, 炼金:智, 烹饪:精, 裁缝:敏'
    结果产出:
      结果分级:
        大失败: '检定值 < (DC - 10) 或 d20为1'
        失败: '(DC - 10) <= 检定值 < DC'
        成功: 'DC <= 检定值 < (DC + 10)'
        大成功: '检定值 >= (DC + 10) 或 d20为20'
      产出效果:
        大失败: 所有材料100%损耗
        失败: 50%材料被损耗
        成功: 制作成功,产物数值取对应品质区间的50%分位
        大成功: 制作成功,产物数值取对应品质区间的90%分位,并触发额外增益
      额外增益:
        批量生产: 产出数量增加10%(向下取整,最少+1),或整批产物特定属性微量提升
        稀有词条: 制作稀有及以上品质物品时,有5%几率额外附加一条弱效正面词条
  非战斗技能检定规则:
    触发原则:
      规则: 仅当一个行动同时满足'结果不确定'与'失败有意义'两个条件时,才触发检定, **系统功能(学习/升级/融合技能/缔结契约等)不触发检定**
      正例: 攀爬湿滑的悬崖,撬锁失败会触发警报
      反例: 走上楼梯,购买商品,日常对话等无风险常规行动
    检定流程:
      行动类型与关联属性:
        - '社交(精): 说服,欺骗,威吓,安抚'
        - '探索(敏): 潜行,盗窃,解除陷阱,特技动作'
        - '知识(智): 调查,鉴定,回忆知识,解读文献'
        - '感知(精): 察觉,洞悉动机,感知魔法'
        - '蛮力(力): 破门,举起重物,挣脱束缚'
      DC: 目标非生物(静态)→'8:非常简单, 10:简单, 15:中等, 25:困难, 35:非常困难, 45:近乎不可能'；目标生物(动态)→'DC=目标方 (关联属性 + 技能/背景加成) + d20池数值'
      注:(对于非常简单的目标，除非情况特殊，否则请让角色们自动成功于此类检定，不要为此掷骰)
      执行检定:
        先(取d20)确定DC
        公式: '(关联属性 + 技能/背景加成) + d20池数值'，属性不可未知
        类型: '静态/动态检定(vs DC)'
    结果判定与生产制作的'结果分级'相同
  面板模板:
    1.战前状态(每回合仅输出1次, 不重复): |
      <div class="cp sp">
        <div class="csf">
          <p class="cn"><user></p>
          <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
          <p>力:X 敏:X 体:X 智:X 精:X 状态及其剩余回合数(若有)</p>
        </div>
        <div class="csf">
          <p class="cn">[队友/召唤物/魔宠]</p>
          <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
          <p>力:X 敏:X 体:X 智:X 精:X 状...</p>
        </div>
        <div class="cse">
          <p class="cn">[敌人名 / 集群名称 (xN)]</p>
          <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
          <p>力:X 敏:X 体:X 智:X 精:X 状... 战斗类型</p>
        </div>
        <div class="cse">
          <p class="cn">第x回合(若资源未消耗完不得更新回合数)</p>
        </div>
      </div>
    2.行动顺序(每回合仅输出一次, 不重复): |
      <div class="cp ao">
        <p class="ph">行动顺序检定:</p>
        <ul class="dl">
          <li><span class="hl">[角色A]:</span> (敏捷[X] × (1 + 修正[Z%])) + 掷骰[Y] = (X × (1 + Z/100)) + Y = <span class="dr">[总值]</span></li>
          <li><span class="hl">[角色B]:</span> 敏捷[X] + 掷骰[Y] = X + Y = <span class="dr">[总值]</span></li>
        </ul>
        <p class="ph">最终顺序: [角色A] → [角色B] → [角色C] → ...</p>
      </div>
    攻击行动: |
      <div class="cp atk">
        <p class="ph">[攻击者]的攻击</p>
        <p class="sh">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX (-XX)</p>
        <p class="ph">攻击检定:</p>
        <p>掷骰[d20] → <span class="dr">结果等级</span></p>
        <p class="ph">伤害计算式:</p>
        <ul class="dl">
          <li><b>初始伤害</b> = [属性]XX×10 × 第x层级Y.Y + [技能]ZZ + [装备]WW = <span class="dm">AAA</span></li>
          <li>
            <b>[物理伤害] (X%)</b>
            <ul class="inl">
              <li>伤害构成: <span class="dm">BBB</span></li>
              <li>装备减免: <span class="dm">CCC</span></li>
              <li>属性减免: <span class="dm">DDD</span></li>
              <li>伤害结算: <span class="dm">EEE</span></li>
            </ul>
          </li>
          <li>
            <b>[能量伤害] (Y%)</b>
            <ul class="inl">
              <li>伤害构成: <span class="dm">FFF</span></li>
              ...
              <li>伤害结算: <span class="dm">III</span></li>
            </ul>
          </li>
            <!-- 其它伤害类型 -->
            ...
          <li><b>基础伤害</b> = EEE + III + ... = <span class="dm">JJJ</span></li>
          <li><b>伤害修正:</b>
              <ul class="inl">
                  <li>检定修正: JJJ × [X.X] = <span class="dm">KKK</span></li>
                  <li>额外增伤: + <span class="dm">LLL</span></li>
              </ul>
          </li>
          <li><b>最终伤害</b> = KKK + LLL /集群(KKK + LLL)×2= <span class="dm">最终数值</span></li>
          <!-- 可选 -->
          <li>目标的“护盾”、“易伤”等状态效果将在此基础上另行结算</li>

        </ul>
        <p class="ph">效果结算清单:</p>
        <ul class="rl">
          <li>✓ [攻击者] 使用 [技能名] 攻击 [目标]。</li>
          <li>→ [目标] 承受了 <span class="dm">XXX</span> 点伤害!</li>
          <li>→ [目标]HP: xxx→ yyy</li>
          <li>✓ [技能名] 附加效果判定:</li>
          <li>→ (检定结果) 效果对抗: [攻方属性+骰] vs [守方属性+骰] → 成功 / 失败</li>
        </ul>
      </div>
    非攻击动作: |
      <div class="cp act">
        <p class="ph">[行动者]的动作</p>
        <p class="sh">HP: XXX/XXX (+XX) | MP: XXX/XXX (-XX) | SP: XXX/XXX</p>
        <p class="ph">行动详情:</p>
        <ul class="dl">
          <li>行动类型: [使用道具/辅助法术/权能/装备能力/逃跑]</li>
          <li>核心能力: [能力名称]</li>
          <li>资源消耗: [具体数值]</li>          
        </ul>
        <p class="ph">效果结算清单:</p>
        <ul class="rl">
          <li>✓ [行动者] 发动了[能力名称]。</li>
          <li>✓ 自身/目标获得 [效果名] 效果。</li>
        </ul>
      </div>
    每回合结束检定: |
      <div class="cp re">
        <p class="ph">终结判定</p>
        <p><b>触发:</b> [角色名] HP低于 [战斗类型] 阈值 (XX%)。</p>
        <p><b>判定:</b> [战斗类型无需检定 → 触发终结 / 意志检定: 掷骰[d20] → (<12终结]</p>
        <p><b>最终结果:</b> [从结果池选择的具体行动]</p>
      </div>
    生产制作: |
      <div class="cp crafting_panel">
        <p class="ph">生产制作: [物品名称] x[数量]</p>
        <p class="sh">制作类型: [锻造/炼金/...] | 核心属性: [力/智/...]</p>
        <p class="ph">检定详情:</p>
        <ul class="dl">
          <li>DC=d20+[材料加成]N+[其它加成]M<span class="dr">[DC值]</span></li>
          <li>检定公式: ([属性]XX + [技能加成]Y + [道具加成]Z) + 骰[d20] = <span class="dr">[总值]</span></li>
          <li>检定结果: <span class="dr">[大失败/失败/成功/大成功]</span></li>
        </ul>
        <p class="ph">产出结果:</p>
        <ul class="rl">
          <li>✓ 消耗材料: [材料A xN, 材料B xM...]</li>
          <li>→ 产出: [物品名] x [最终数量]</li>
          <li>→ 品质: [普通(攻击: XX)/优良(防御: YY)...]</li>
          <li>→ 额外效果: [获得额外词条/无]</li>
        </ul>
      </div>
    非战斗技能检定: |
      <div class="cp skill_check_panel">
        <p class="ph">[检定方]检定: [行动名称]</p>
        <p class="sh">检定类型: [静态检定/动态检定] | 核心属性: [力/敏/...]</p>
        <p class="ph">检定详情:</p>
        <ul class="dl">
          <!-- 动态 -->
          <li>[目标方]([属性]XX + [技能/背景/道具/装备等]加成Y) + 掷骰[d20]<span class="dr">[DC值]</span></li>
          <!-- 静态 -->
          <li>DC: <span class="dr">[DC值]</span></li>

          <li>[检定方]([属性]XX + [技能/背景/道具/装备等]加成Y) + 掷骰[d20] vs [DC] = <span class="dr">[总值]</span></li>
          <li>检定结果: <span class="dr">[大失败/失败/成功/大成功]</span></li>
        </ul>
        <p class="ph">结果:</p>
        <ul class="rl">
          <li>→ [描述检定成功或失败带来的直接后果]</li>
        </ul>
      </div>
    <user>胜利/成功反馈: |
      <div class="cp vic">
        <h4 class="ph">战斗胜利!/逃跑成功!/制作成功!</h4>

        <p>[简述结局或成果]</p>
        <hr>
        <!-- 可选(任务无exp奖励) -->
        <p>获得EXP: <span class="hl">+XXX EXP</span></p>
        <!-- 可选 -->
        <p>获得FP: <span class="hl">+XXX FP</span></p>
      </div>
    <user>失败反馈: |
      <div class="cp def">
        <h4 class="ph">战斗失败.../制作失败...</h4>
        <p>[简述失败后果]</p>
      </div>

注: 灵活搭配拆分组合使用各个面板的每一行，数据信息无/0则不显示在面板；每一个面板分别用<actions_info></actions_info>包裹，仅在战斗/生产制作/非战斗技能检定时使用
</行动协议>
