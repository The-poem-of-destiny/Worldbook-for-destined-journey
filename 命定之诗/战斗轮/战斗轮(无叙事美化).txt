<战斗规则>
# 核心指令: 当触发任何战斗场景时,必须严格遵循本协议进行处理。

# 输出要求: 当战斗开始时，先进行先攻检定与展示，轮到<user>时结束正文，战斗过程中不替<user>作战斗决定，每次输出完整一回合。

# --- 阶段一: 内部思考与演算 ---
# 在生成任何战斗描述前,必须在内部完成以下思考步骤:

0) 回合预生成骰子池:
核心规则: 本回合所有需要随机数的场合,都必须从此处的检定池中严格按顺序取用。你必须在内部维护每个池子的消耗索引(从1开始),每个数值仅能使用一次。
d20检定池 (共60颗): {{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}}

1) 战前准备:
评估: 判定战型(遭遇/精英/Boss)与烈度。
集群: 若存在≥3个同类低级敌人, 聚合为【集群】单位 (HP=个体HP/MP/SP×N, 统一行动)。
单位列表: 确认所有参战单位及当前资源/状态。

2) 行动序列:
先攻: (敏捷 × (1 + %修正)) + d20池数值 + 固定修正。
排序: 从高到低生成本回合行动轴。

3) 行动执行:
   行动拆分: 每单位每回合拥有一个[攻击]资源和一个[动作]资源。根据技能标签，使用技能会消耗其对应的资源。单位在其行动轮次中可使用其拥有的全部资源，所有单位行动完毕即为一回合结束。权能/法则的主动效果会同时消耗[攻击]与[动作]两个资源。

   攻击流程:
      a) 攻击检定: 取池d20 → 判定结果等级 (20:暴击, 14-19:有效, 8-13:勉强, 4-7:擦伤, 1-3:失手)。

      b) 伤害计算:
         i. 核心伤害计算 (查阅<核心数值总表>)
            - 初始伤害 = 关联属性×10 × 层级系数 + 所使用技能威力 + 武器攻击力
            - 拆分伤害: 根据技能标签以及效果描述，将初始伤害拆分为不同伤害类型的伤害构成 (例如: 物理60%，能量40%)。
            - 计算减免: 对每个伤害，独立套用其对应的减免公式:
                - 装备减免: 装备减免值 = 该伤害构成数值 × (被击中部位的装备防御值 / (被击中部位的装备防御值 + 3000))
                - 属性减免百分比:
                    - 物理减免% = (最终体质 + 最终力量 + 最终敏捷) × 0.25%
                    - 能量减免% = (最终精神 + 最终智力) × 0.4%
                    - 精神减免% = 最终精神 × 0.8%
                    - 真实减免% = 0%
                - 结算伤害(该类型) = (该伤害构成数值 - 装备减免值) × (1 - 对应的属性减免%)
            - 汇总: 将所有类型伤害包的结算伤害相加，得到 基础伤害。

         ii. 攻击方效果修正
            - 修正伤害 = 基础伤害 × 攻击检定结果修正 (暴击×1.5, 有效×1.0, 勉强×0.8, 擦伤×0.3, 失手×0)
            - 最终伤害 = 修正伤害 + 所有攻击方附加的额外固定伤害 (如装备附魔、要素效果等)。

         iii. 防御方状态结算
            - 对 最终伤害 进行百分比增减 (如目标的“易伤”状态使伤害×1.2，“守护”状态使伤害×0.8)。
            - 扣除目标的护盾值。
            - 剩余的伤害值最终扣减在目标的HP上。

      c) 伤害应用:
         - 单体: 施加最终伤害。
         - 集群(单体技能): 扣除总HP, 根据总承受伤害/个体HP计算消灭数。
         - 集群(范围技能): 最终伤害 × 现存数量N 为集群总伤害, 扣除总HP并更新消灭数。
         - 多目标(范围技能): 攻击检定1次，对范围内每个目标独立计算减免和最终伤害。

      d) 附加效果:
         - 暴击: 必定触发。
         - 有效/勉强命中: (攻方核心属性+d20) vs (守方核心属性+d20) 对抗。
         - 擦伤/失手: 无法触发。

   动作流程:
      - 类型: 使用道具, 辅助法术, 装备能力, 逃跑。
      - 逃跑: (<user>敏捷+d20) vs (场上最高敏捷敌人+d20)。

4) 回合结束:
胜负判定: 检查一方是否全灭或成功逃跑。
士气检定: 资源低于阈值(集群50%/普40%/精20%/Boss10%)的敌人, 取池d20。d20<5逃跑, d20>17进入【美德】状态 (下次攻击必暴击或下次承伤减半)。集群士气检定失败则直接溃散。

# --- 阶段二: 格式化输出 (保持 html 不变) ---
# 基于内部演算结果, 严格遵循“数据面板 + 去游戏化叙事”的双层结构输出。所有面板必须严格遵循此 html 部分的格式，战斗轮CSS 内容已在外部处理，禁止生成，且只适用与战斗，不包括其它美化。

<!-- 1) 战前状态展示 每回合展示 -->
<div class="cp sp">
  <div class="csf">
    <p class="cn">{{user}}</p>
    <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
    <p>力:X 敏:X 体:X 智:X 精:X</p>
  </div>
  <div class="csf">
    <p class="cn">[队友/召唤物/魔宠]</p>
    <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
    <p>力:X 敏:X 体:X 智:X 精:X</p>
  </div>
  <!-- 可重复友方块 -->
  <div class="cse">
    <p class="cn">[敌人名 / 集群名称 (xN)]</p>
    <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
    <p>力:X 敏:X 体:X 智:X 精:X</p>
  </div>
  <!-- 可重复敌方块 -->
  </div>
  <div class="cse">
    <p class="cn">第x回合</p>
    <p>[列出60个掷骰结果]</p>
</div>

<!-- 2) 行动顺序轴 每场战斗只在开始时展示一次且面板后不进行叙事内容 -->
<div class="cp ao">
  <p class="ph">行动顺序检定:</p>
  <ul class="dl">
    <li><span class="hl">[角色A]:</span> (敏捷[X] × (1 + 修正[Z%])) + 掷骰[Y] = (X × (1 + Z/100)) + Y = <span class="dr">[总值]</span></li>
    <li><span class="hl">[角色B]:</span> 敏捷[X] + 掷骰[Y] = X + Y = <span class="dr">[总值]</span></li>
    <!-- 可继续列出 -->
  </ul>
  <p class="ph">最终顺序: [角色A] → [角色B] → [角色C] → ...</p>
</div>

<!-- 3) 行动轮次面板 · 攻击面板 -->
<div class="cp atk">
  <p class="ph">[攻击者]的攻击</p>
  <p class="sh">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX (-XX)</p>
  
  <p class="ph">攻击检定:</p>
  <p>掷骰[d20] → <span class="dr">结果等级: 完美一击! / 有效命中 / 勉强命中 / 被格挡 / 失手</span></p>
  
  <p class="ph">伤害计算式:</p>
  <!-- 严格分步计算与展示。 -->
  <ul class="dl">
    <!-- 核心伤害计算 -->
    <li><b>初始伤害</b> = [力/体/敏/智/精]XX×10 × 第x层级A.A + [技能名]YY + [装备名]ZZ = <span class="dm">AAA</span></li>
    
    <!-- 根据技能标签效果描述中的伤害类型和占比, 动态生成以下伤害计算。如果只有一种伤害类型, 则只显示一个伤害。 -->
    <li>
      <b>[物理伤害] (占比X%)</b>
      <ul class="inl">
        <li>伤害构成: AAA × X% = <span class="dm">BBB</span></li>
        <li>装备减免: BBB × (防御 / (防御+3000)) = <span class="dm">CCC</span></li>
        <li>属性减免: (BBB - CCC) × ((体+力+敏)×0.25%) = <span class="dm">DDD</span></li>
        <li>伤害结算: (BBB - CCC) - DDD = <span class="dm">EEE</span></li>
      </ul>
    </li>
    <li>
      <b>[能量伤害] (占比Y%)</b>
      <ul class="inl">
        <li>伤害构成: AAA × Y% = <span class="dm">FFF</span></li>
        <li>装备减免: FFF × (防御 / (防御+3000)) = <span class="dm">GGG</span></li>
        <li>属性减免: (FFF - GGG) × ((精+智)×0.4%) = <span class="dm">HHH</span></li>
        <li>伤害结算: (FFF - GGG) - HHH = <span class="dm">III</span></li>
      </ul>
    </li>
    <!-- ...可选添加 精神/真实 伤害... -->

    <li><b>基础伤害</b> = 所有伤害结算值相加 (EEE + III + ...) = <span class="dm">JJJ</span></li>

    <!-- 攻击方效果修正 -->
    <li><b>伤害修正:</b>
        <ul class="inl">
            <li>攻击检定修正: JJJ × 结果修正[X.X] = <span class="dm">KKK</span></li>
            <li>装备附魔/要素等增伤: + <span class="dm">LLL</span></li>
        </ul>
    </li>

    <li><b>最终伤害</b> = 修正后伤害[KKK] + 额外增伤[LLL] = <span class="dm">最终数值</span></li>
    <!-- 可选 -->
    <li class="no-italic">目标的“护盾”、“易伤”等状态效果将在此基础上另行结算</li>
  </ul>

  <p class="ph">效果结算清单:</p>
  <ul class="rl">
    <li>✓ [攻击者] 使用了 [技能名] 攻击 [目标]。</li>
    <li>→ [目标] 承受了 <span class="dm">XXX</span> 点伤害! (若为集群，此处可描述“集群总计承受了 YYY 点伤害，N个单位被消灭！”)</li>
    <li>→ [目标]HP变化: xxx→ yyy</li>
    <!-- 以下根据攻击结果等级选择性显示 -->
    <li>✓ [技能名] 的附加效果 [效果名] 触发判定:</li>
    <li>→ (完美一击) 效果 必定触发!</li>
    <li>→ (有效/勉强命中) 附带效果对抗: [攻击方][属性A] + 掷[X] vs [目标方][属性B] + 掷[Y] → (A + X) vs (B + Y) → 施加成功! / 抵抗成功!</li>
    <li>→ (被格挡/失手) 效果 无法触发。</li>
  </ul>
</div>

<!-- 3) 行动轮次面板 · 动作面板 -->
<div class="cp act">
  <p class="ph">[行动者]的动作</p>
  <p class="sh">HP: XXX/XXX (+XX) | MP: XXX/XXX (-XX) | SP: XXX/XXX</p>

  <p class="ph">行动详情:</p>
  <ul class="dl">
    <li>行动类型: [使用道具 / 施展辅助法术 / 发动权能 / 发动装备能力 / 尝试逃跑]</li>
    <li>核心能力: [能力名称]</li>
    <li>资源消耗: [XX MP / XX SP / 25% 最大资源]</li>
  </ul>

  <p class="ph">权能对抗 (若触发):</p>
  <ul class="dl">
    <li>强度检定: 行动者精神[SPI] + 掷骰[p1] = SPI + p1 = XX</li>
    <li>抵抗检定: 目标精神[SPI] + 掷骰[p2] = SPI + p2 = YY</li>
    <li>结果: 完美生效 / 正常生效 / 效果削弱 / 抵抗成功</li>
  </ul>

  <p class="ph">逃跑检定 (若触发):</p>
  <ul class="dl">
    <li>你的检定: 敏捷[DEX] + 掷骰[e1] = DEX + e1 = XX</li>
    <li>敌人拦截: 敌人敏捷[DEX] + 掷骰[e2] = DEX + e2 = YY</li>
    <li>结果: 逃跑成功 / 逃跑失败</li>
  </ul>

  <p class="ph">效果结算清单:</p>
  <ul class="rl">
    <li>✓ [行动者] 发动了[能力名称]。</li>
    <li>✓ 自身/目标获得 状态/效果名 效果。</li>
    <li>✓ 战场环境发生变化: 变化简述。</li>
  </ul>
</div>

<!-- 4) 回合结束事件面板 (按需显示) -->
<div class="cp re">
  <p class="ph">回合结束检定</p>
  <p><b>触发条件:</b> [敌人名] 的资源低于阈值。</p>
  <p><b>士气检定:</b> 掷骰结果 [r3] → 结果</p>
  <p><b>最终结果:</b> 逃跑成功! / 逃跑失败! / 意志升华，进入【美德】状态! / (集群) 集群溃散!</p>
</div>

<!-- 5) 战斗结束面板 · 胜利/逃跑成功 -->
<!-- 若战斗结束原因为<user>成功逃跑, 则此面板中【禁止】生成“获得EXP”和“获得FP”这两行。 -->
<div class="cp vic">
  <h4 class="ph">战斗胜利!/逃跑成功!</h4>
  <p class="ph">简述敌人的最终结局，如: 敌方全灭 / 目标被成功控制 / 敌人逃跑 / 你成功脱离了战斗。</p>
  <p>获得EXP: <span class="hl">+XXX EXP</span></p>
  <p>获得FP: <span class="hl">+XXX FP</span></p>
</div>

<!-- 5) 战斗结束面板 · 失败 -->
<div class="cp def">
  <h4 class="ph">战斗失败...</h4>
  <p class="ph">简述失败的直接后果，如: 玩家被击败 / 任务目标被摧毁。</p>
  <p class="no-italic">强制根据胜利方敌人的性格与目标,不可避免地展开后续故事,如被俘虏、羞辱、洗劫等。</p>
</div>

instruction_narrative: |
  叙事守则:
  - 基于<fiction_style>
  - 避免回合制游戏叙事，注重沉浸感，避免任何游戏/数据术语
  - 必须严格反映面板结算结果，禁止为了叙事效果而提前或改变战斗结果。一个单位的死亡必须以其HP≤0为唯一前提。
  - <数值状态关系>描述人物状态
  - 除行动顺序轴面板之外，每个动作面板之后进行沉浸叙事，将面板行为动作转换叙事，禁止解释与括号说明。
  - 咒语与技能文字美化
  - 以具象化结果与体感描写替代规则术语（如“趔趄”“灼痕”“气浪逼退”“寒霜在指节结晶”）。
  - 场景破坏侧面描写，展现奇幻感与破坏力
</战斗规则>